<!DOCTYPE html>
<html>
<head>
    <title>Stream Player</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css">

    <style>
        body { margin:0; background:black; }
        .shaka-video-container { position:absolute; inset:0; }
        video { width:100%; height:100%; object-fit:contain; }
    </style>
</head>

<body>

<!-- TELEGRAM POPUP (UNCHANGED) -->
<div id="popup">
  <div class="popup-content">
    <h2>Support Us!</h2>
    <p>Join our Telegram channel</p>
    <button onclick="window.open('https://t.me/+3sgGQcDP6ExhYTU1','_blank')">Join Now</button>
    <button onclick="closePopup()">Already Joined</button>
  </div>
</div>

<script>
function closePopup(){ document.getElementById('popup').style.display='none'; }
</script>

<div class="shaka-video-container">
  <video id="video" autoplay playsinline preload="metadata"></video>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {

  shaka.polyfill.installAll();
  if (!shaka.Player.isBrowserSupported()) return;

  // 1️⃣ Resolve stream FIRST
  const id = new URLSearchParams(location.search).get('id');
  if (!id) return;

  const res = await fetch('https://live7.pages.dev/api/stream.php');
  const list = await res.json();
  const s = list.find(x => x.id === id);
  if (!s) return;

  // 2️⃣ Prepare config BEFORE creating player
  const playerConfig = {
    streaming: {
      bufferingGoal: 20,
      rebufferingGoal: 5,
      bufferBehind: 25
    }
  };

  if (s.mpd && s.key) {
    const [kid,key] = s.key.split(':');
    playerConfig.drm = {
      clearKeys: { [kid]: key }
    };
  }

  // 3️⃣ Create player ONCE
  const video = document.getElementById('video');
  const player = new shaka.Player(video);
  new shaka.ui.Overlay(player, document.querySelector('.shaka-video-container'), video);

  player.configure(playerConfig);

  // 4️⃣ Load stream
  await player.load(s.mpd || s.m3u8);

  // 5️⃣ Autoplay logic (same as working file)
  try {
    video.muted = false;
    await video.play();
  } catch {
    video.muted = true;
    await video.play();
  }
});
</script>

</body>
</html>
